# 2.3因特网中的电子邮件

> 1. 因特网电子邮件系统的3个主要组成部分：**用户代理(user agent)**、**邮件服务器(mail server)**、**简单邮件传输协议(Simple Mail Transfer Protocol,SMTP)**
>
> 2. 邮件服务器形成了电子邮件体系结构的**核心**。每个接收方在其中的某个邮件服务器上有一个**邮箱**。
>
> 3. 一个典型的发送邮件过程：
>    从发送方的用户代理开始，传输到发送方的邮件服务器，再传输到接收方的邮件服务器，然后在这里被分发到接收方的邮箱中。
>    当发送方不能将邮件交付给接收方的邮件服务器时，发送方的邮件服务器在一个**报文队列**中保持该报文，并在以后再次尝试发送。通常30分钟左右进行一次尝试。如果几天以后仍不能成功，服务器就删除该报文并以电子邮件的形式通知发送方。
>
> 4. SMTP是因特网电子邮件中主要的**应用层协议**。它使用**TCP可靠数据传输服务**，从发送方的邮件服务器向接收方的邮件服务器发送邮件。SMTP也有两部分：
>
>    > - 运行在发送方邮件服务器的客户端
>    > - 运行在接收方邮件服务器的服务器端。
>    > - 每台邮件服务器上既运行SMTP的客户端也运行SMTP的服务器端。





### 2.3.1 SMTP

> 1. SMTP是因特网电子邮件的核心。[RFC 5321]
>
> 2. SMTP限制所有报文的体部分（不只是其首部）只能采用简单的7比特ASCII码表示。
>
> 3. 一个简单的过程
>
>    > - Alice调用她的邮件代理程序并提供Bob的邮件地址，撰写报文，然后指示用户代理发送该报文
>    > - Alice的用户代理把报文发给她的邮件服务器，在那里该报文被放在报文队列中。
>    > - 运行在Alice的邮件服务器上的SMTP客户端发现了报文队列中的这个报文，它就创建一个到运行在Bob的邮件服务器上的SMTP服务器的TCP连接
>    > - 经过一些初始的SMTP握手以后，SMTP客户通过该TCP连接发送Alice的报文
>    > - 在Bob的邮件服务器上，SMTP的服务器端接收该报文，Bob的邮件服务器然后将该报文放入Bob的邮箱中。
>
>    a.SMTP一般不使用中间邮件服务器发送邮件(类型CDN)，即使这两个服务器位于地球两端也是通过TCP直接相连
>
>    b.如果Bob的邮件服务器没有开机，该报文会保留在Alice的邮件服务器上并等待进行新的尝试。
>
> 4. SMTP发送一个报文的过程
>
>    > - 首先，客户SMTP在25端口建立一个到服务器SMTP的TCP连接，如果该服务器没有开机，客户会在稍后继续尝试连接。
>    > - 一旦连接建立，服务器和客户执行某些应用层的握手。SMTP的客户和服务器在传输信息之前先相互介绍。在SMTP的握手阶段，SMTP客户指示发送方的邮件地址和接收方的邮件地址。一旦彼此介绍完毕以后，客户发送该报文。
>    > - 该客户如果有另外的报文要发送到该服务器，就在该相同的TCP连接上重复这种处理，否则他指示TCP关闭连接。
>
>    SMTP能依赖TCP提供的可靠数据传输无差错地将邮件投递到接收服务器。



****

### 2.3.2 SMTP与HTTP的对比

>1. **相同点**
>
>   > - 这两个协议都用于从一台主机向另一台主机传送文件
>   > - 当文件传送时，**SMTP使用持续连接**，HTTP也能选择使用持续连接。
>
>2. **不同点**
>
>   > - HTTP主要是一个**拉协议(pull protocol)**，SMTP基本上是一个**推协议(push protocol)**
>   > - SMTP要求每个报文(包括它们的体)采用7比特ASCII码（如果某报文采用了非7比特ASCII码，则该报文必须按7比特ASCII码进行编码）。HTTP则没有这种限制。
>   > - 关于如何处理一个既包含文本又包含图片的文档：HTTP把**每个对象**封装到**它自己的HTTP响应报文中**；SMTP则把**所有报文对象放在一个报文中**。





****

### 2.3.3 邮件报文格式

> 1. 一个邮件报文包含首部行和一个空行和一个报文体。每个首部必须含有一个`From:`和`To:`
>
> 2. 一个典型的报文**首部**如下：
>
>    > ```SMTP
>    > From: alice@crepes.fr
>    > To: bob@hamburger.edu
>    > Subject: Searching for the meaning of life
>    > ```
>
> 3. 在报文首部以后，紧接着一个**空白行**，然后是以**ASCII格式**表示的**报文体**





***

### 2.3.4 邮件访问协议

> 1. 通常，发送方的用户代理用SMTP将电子邮件报文推入到她的邮件服务器；然后她的邮件服务器再用SMTP将该邮件中继到Bob的邮件服务器。（**分为两步**）
> 2. 但**接收方的用户代理不能使用SMTP从接收方邮件服务器获得报文**，因为**SMTP是一个推协议**，而**取报文是一个拉操作**。所以引入了一些特殊的邮件访问协议来解决这个问题，如：第三版邮局协议(Post Office Protocol --version3, POP3)、因特网邮件访问协议(Internet Mail Access Protocol)、以及HTTP。
> 3. SMTP用来将邮件从发送方的用户代理传送到发送方的邮件服务器；SMTP也用来将邮件从发送方的邮件服务器传输到接收方的邮件服务器。诸如**POP3**这样的邮件访问协议则用来**将邮件从接收方的邮件服务器传送到接收方的用户代理**。

1. **POP3**

   > 1. POP3([RFC 1939])是一个极为简单邮件访问协议。因为简单，所以功能有限
   >
   > 2. 当用户代理打开了一个到邮件服务器端口110的TCP连接后，POP3就开始工作， 随着建立TCP连接，POP3按照三个阶段进行工作:
   >
   >    > - **特许阶段**：用户代理发送（以明文形式）用户名和口令以鉴别用户。
   >    >
   >    >   > 特许阶段有两个主要的命令：`user <username>`、`pass <password>`。
   >    >
   >    > - **事务处理阶段**：用户代理取回报文，同时在这个阶段用户代理还能进行如下操作：a.对报文做删除标记 b.取消报文的删除标记  c.获取邮件的统计信息
   >    >
   >    >   > 在POP3的事务处理过程中，用户代理发出一些命令，服务器对每个命令做出回答。回答有两种：
   >    >   >
   >    >   > 1. **+OK**（有时后面还跟有服务器到用户的数据） 被服务用来指示前面的命令是正常的
   >    >   > 2. **-ERR**    被服务器用来指示前面的命令出了某些差错
   >    >   >
   >    >   > 使用POP3的用户代理通常被用户配置为“**下载并删除**”或“**下载并保留**”。如果使用下载并删除，用户代理发出 `list`、`retr`、`dele`命令，如果使用**下载并删除**，那么**邮件就只能在一台机器上被接收**。如果希望能在**多台机器上被读取**的话，可以使用**下载并保留**方式
   >    >
   >    > - **更新阶段**：在用户发出quit命令之后，结束该POP3会话，此时，该邮件服务器删除那些被标记为删除的报文
   >
   > 3. 在用户代理与用户服务器之间的**POP3会话期间**，该POP3服务器**保留了一些状态信息**；特别是记录了哪些用户报文被标记为删除了。然而，**POP3服务器**并**不在**POP3**会话过程**中**携带状态信息**。会话中不包括状态信息大大简化了POP3服务的实现。
   >
   >    > Q：POP3服务器不携带状态信息但保留状态信息的意思是什么？

2. **IMAP**

   > 1. POP3无法做到：使用一个在远程服务器上的层次文件夹，并可以从任意一台机器对所有报文进行访问，POP3没有给用户提供任何**创建远程文件夹并为报文指派文件夹**的方法。由此，IMAP([RFC 3501])应运而生。
   > 2. **IMAP服务器**把**每个报文与一个文件夹联系**起来；当报文第一次到达服务器时，它与收件人的INBOX文件夹相关联。收件人能把邮件移到一个新的、用户创建的文件夹中，阅读、删除邮件等。
   > 3. IMAP协议为用户提供了创建文件夹以及将邮件从一个文件夹移动到另一个文件夹的命令，IMAP还为用户提供了在远程文件夹中查询邮件的命令，按照指定条件去匹配查询的邮件。
   > 4. 与POP3不同，**IMAP服务器维护了IMAP会话的用户状态信息**，例如文件夹的名字以及哪些报文与哪些文件夹相关联。
   > 5. IMAP的另一个重要特性是它具有**允许用户代理获取报文某些部分的命令**。例如，一个用户代理可以**只读取一个报文的报文首部**，或只是一个多部份MIME报文的一部分。当用户代理和其邮件服务器之间使用低带宽连接（如一个低速调制解调器链路）时，该特性非常有用。使用低带宽连接时，用户可能不想取回他邮件中所有的邮件。

3. **基于Web的电子邮件**

   > 1. 使用这种服务，**用户代理就是普通的浏览器**，用户和他的远程邮箱之间的通信则通过**HTTP**进行。
   > 2. 当一个收件人想从他的邮箱中**访问一个报文**时，该电子邮件报文从接收方的邮件服务器发送到他的浏览器，**使用的是HTTP协议**。当发送方要**发送一封电子邮件报文时**，该电子邮件从发送方的浏览器发送到他的邮件服务器**，使用的是HTTP**而不是SMTP，**但是发送方的邮件服务器和其他邮件服务器之间的发送和接收邮件仍然使用的是SMTP协议。**



****

